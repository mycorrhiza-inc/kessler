# Hash-based Markdown Retrieval Endpoint

## Endpoint

`GET /files/markdown/hash/{hash}`

Retrieves the markdown text of the first file matching the provided content hash.

## Path Parameters

- `hash` (string): The hash of the target file (e.g. SHA256 encoded string).

## Query Parameters

- `match_lang` (string, optional): Language code to filter text (e.g. `en`, `es`).
- `original_lang` (bool, optional): When set to `true`, returns the original text rather than translated.

## Handler Implementation

```go
func FileMarkdownByHashHandler(w http.ResponseWriter, r *http.Request)
```

1. Parse `hash` from URL path using `mux.Vars`.
2. Execute `files.HashGetUUIDsFile(q, ctx, hash)` to map the hash to UUIDs.
   - Return `404 Not Found` if no UUIDs are found or on error.
3. Select the first UUID.
4. Construct `GetFileParam` with:
   - `Queries: q`
   - `Context: ctx`
   - `PgUUID: selected UUID`
   - `Private: false`
5. Retrieve query parameters:
   - `original := r.URL.Query().Get("original_lang") == "true"`
   - `matchLang := r.URL.Query().Get("match_lang")`
6. Call `files.GetSpecificFileText(fileParams, matchLang, original)` to get markdown text.
   - Return `404 Not Found` if no text matches or on error.
7. Set response header `Content-Type: text/plain`.
8. Write markdown text in response body.

## Error Handling

- 404 Not Found:
  - No file UUIDs found for hash.
  - No text matches filter criteria.
- 500 Internal Server Error:
  - Unexpected errors from database or text retrieval.

## Non-Disruptive Integration

- No changes to existing routes or middleware.
- Added minimal handler in `file_read_handler.go`.
- New endpoint can be registered alongside existing routes:
  ```go
  router.HandleFunc(
      "/files/markdown/hash/{hash}",
      handler.FileMarkdownByHashHandler,
  ).Methods("GET")
  ```

## Testing Considerations

- Unit test mocking `dbstore.Queries` and `files.GetSpecificFileText`.
- Integration test with seeded database entries and S3 texts.

---

*Generated by Goose on 2025-05-10*